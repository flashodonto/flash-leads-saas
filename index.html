-- =============================================
-- FLASH LEADS SAAS - SCHEMA OTIMIZADO
-- Execute este script completo no Supabase SQL Editor
-- =============================================

-- PARTE 1: LIMPEZA (caso existam tabelas antigas)
-- =============================================
DROP POLICY IF EXISTS "Users can view own leads" ON leads;
DROP POLICY IF EXISTS "Users can insert own leads" ON leads;
DROP POLICY IF EXISTS "Users can update own leads" ON leads;
DROP POLICY IF EXISTS "Users can delete own leads" ON leads;
DROP POLICY IF EXISTS "Users can view own settings" ON user_settings;
DROP POLICY IF EXISTS "Users can insert own settings" ON user_settings;
DROP POLICY IF EXISTS "Users can update own settings" ON user_settings;

DROP TABLE IF EXISTS activity_logs CASCADE;
DROP TABLE IF EXISTS subscriptions CASCADE;
DROP TABLE IF EXISTS procedure_templates CASCADE;
DROP TABLE IF EXISTS leads CASCADE;
DROP TABLE IF EXISTS user_settings CASCADE;

-- PARTE 2: CRIA√á√ÉO DAS TABELAS PRINCIPAIS
-- =============================================

-- 1. Tabela de Configura√ß√µes do Usu√°rio
CREATE TABLE user_settings (
  id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  clinic_name TEXT DEFAULT 'Minha Cl√≠nica',
  whatsapp TEXT,
  default_message TEXT DEFAULT 'Ol√° {nome}! üòä

Tudo bem? Aqui √© da {clinica} ü¶∑

Vi que voc√™ tem interesse em {procedimento}. Que tal agendar uma consulta?

Temos hor√°rios dispon√≠veis esta semana e condi√ß√µes especiais para voc√™!

Posso te ajudar com mais informa√ß√µes? üìû',
  auto_reminders BOOLEAN DEFAULT FALSE,
  reminder_days INTEGER DEFAULT 2,
  subscription_plan TEXT DEFAULT 'free',
  subscription_status TEXT DEFAULT 'active',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Tabela de Leads
CREATE TABLE leads (
  id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  phone TEXT NOT NULL,
  procedure TEXT NOT NULL,
  status TEXT DEFAULT 'novo' CHECK (status IN ('novo', 'agendado', 'compareceu', 'faltou')),
  observations TEXT,
  appointment_date DATE,
  appointment_time TIME,
  appointment_duration INTEGER DEFAULT 60,
  appointment_location TEXT,
  attendance_date DATE,
  attendance_time TIME,
  last_contact TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Tabela de Assinaturas (para controle de planos)
CREATE TABLE subscriptions (
  id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  stripe_customer_id TEXT,
  stripe_subscription_id TEXT,
  plan_type TEXT DEFAULT 'free' CHECK (plan_type IN ('free', 'pro', 'enterprise')),
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'canceled')),
  current_period_start TIMESTAMP WITH TIME ZONE,
  current_period_end TIMESTAMP WITH TIME ZONE,
  cancel_at_period_end BOOLEAN DEFAULT FALSE,
  leads_limit INTEGER DEFAULT 50,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- PARTE 3: POL√çTICAS DE SEGURAN√áA (RLS)
-- =============================================

-- Habilitar Row Level Security
ALTER TABLE user_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;

-- Pol√≠ticas para user_settings
CREATE POLICY "Users can view own settings" ON user_settings
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own settings" ON user_settings
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own settings" ON user_settings
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own settings" ON user_settings
  FOR DELETE USING (auth.uid() = user_id);

-- Pol√≠ticas para leads
CREATE POLICY "Users can view own leads" ON leads
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own leads" ON leads
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own leads" ON leads
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own leads" ON leads
  FOR DELETE USING (auth.uid() = user_id);

-- Pol√≠ticas para subscriptions
CREATE POLICY "Users can view own subscriptions" ON subscriptions
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own subscriptions" ON subscriptions
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own subscriptions" ON subscriptions
  FOR UPDATE USING (auth.uid() = user_id);

-- PARTE 4: √çNDICES PARA PERFORMANCE
-- =============================================

-- √çndices para leads
CREATE INDEX IF NOT EXISTS idx_leads_user_id ON leads(user_id);
CREATE INDEX IF NOT EXISTS idx_leads_status ON leads(status);
CREATE INDEX IF NOT EXISTS idx_leads_created_at ON leads(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_leads_user_status ON leads(user_id, status);
CREATE INDEX IF NOT EXISTS idx_leads_appointment_date ON leads(appointment_date);

-- √çndices para user_settings
CREATE INDEX IF NOT EXISTS idx_user_settings_user_id ON user_settings(user_id);

-- √çndices para subscriptions
CREATE INDEX IF NOT EXISTS idx_subscriptions_user_id ON subscriptions(user_id);

-- PARTE 5: TRIGGERS PARA ATUALIZA√á√ÉO AUTOM√ÅTICA
-- =============================================

-- Fun√ß√£o para atualizar updated_at automaticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Triggers para atualizar updated_at
DROP TRIGGER IF EXISTS update_user_settings_updated_at ON user_settings;
CREATE TRIGGER update_user_settings_updated_at 
  BEFORE UPDATE ON user_settings
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_leads_updated_at ON leads;
CREATE TRIGGER update_leads_updated_at 
  BEFORE UPDATE ON leads
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_subscriptions_updated_at ON subscriptions;
CREATE TRIGGER update_subscriptions_updated_at 
  BEFORE UPDATE ON subscriptions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- PARTE 6: FUN√á√ïES PERSONALIZADAS
-- =============================================

-- Fun√ß√£o para obter estat√≠sticas do usu√°rio
CREATE OR REPLACE FUNCTION get_user_stats(user_uuid UUID)
RETURNS JSONB AS $$
DECLARE
    stats JSONB;
    current_month_start DATE;
BEGIN
    current_month_start := DATE_TRUNC('month', CURRENT_DATE);
    
    SELECT jsonb_build_object(
        'total_leads', COUNT(*),
        'leads_novo', COUNT(*) FILTER (WHERE status = 'novo'),
        'leads_agendado', COUNT(*) FILTER (WHERE status = 'agendado'),
        'leads_compareceu', COUNT(*) FILTER (WHERE status = 'compareceu'),
        'leads_faltou', COUNT(*) FILTER (WHERE status = 'faltou'),
        'leads_mes', COUNT(*) FILTER (WHERE created_at >= current_month_start),
        'taxa_agendamento', 
            CASE 
                WHEN COUNT(*) > 0 THEN 
                    ROUND((COUNT(*) FILTER (WHERE status IN ('agendado', 'compareceu', 'faltou'))::NUMERIC / COUNT(*)) * 100, 0)
                ELSE 0 
            END,
        'taxa_comparecimento',
            CASE 
                WHEN COUNT(*) FILTER (WHERE status IN ('compareceu', 'faltou')) > 0 THEN
                    ROUND((COUNT(*) FILTER (WHERE status = 'compareceu')::NUMERIC / 
                          COUNT(*) FILTER (WHERE status IN ('compareceu', 'faltou'))) * 100, 0)
                ELSE 0
            END
    ) INTO stats
    FROM leads 
    WHERE user_id = user_uuid;
    
    RETURN stats;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Fun√ß√£o para verificar limite de leads (plano gratuito)
CREATE OR REPLACE FUNCTION check_leads_limit(user_uuid UUID)
RETURNS BOOLEAN AS $$
DECLARE
    current_count INTEGER;
    user_limit INTEGER;
    user_plan TEXT;
BEGIN
    -- Buscar plano e limite do usu√°rio
    SELECT 
        COALESCE(s.plan_type, us.subscription_plan, 'free'),
        CASE 
            WHEN COALESCE(s.plan_type, us.subscription_plan, 'free') = 'free' THEN 50
            WHEN COALESCE(s.plan_type, us.subscription_plan, 'free') = 'pro' THEN 999999
            WHEN COALESCE(s.plan_type, us.subscription_plan, 'free') = 'enterprise' THEN 999999
            ELSE 50
        END
    INTO user_plan, user_limit
    FROM user_settings us
    LEFT JOIN subscriptions s ON us.user_id = s.user_id
    WHERE us.user_id = user_uuid;
    
    -- Contar leads atuais
    SELECT COUNT(*) INTO current_count
    FROM leads 
    WHERE user_id = user_uuid;
    
    -- Retornar se est√° dentro do limite
    RETURN current_count < user_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- PARTE 7: DADOS INICIAIS
-- =============================================

-- Inserir dados de exemplo para desenvolvimento (opcional)
-- Descomente se quiser dados de teste
/*
INSERT INTO user_settings (user_id, clinic_name, whatsapp) VALUES 
('00000000-0000-0000-0000-000000000000', 'Cl√≠nica Exemplo', '(11) 99999-9999');
*/

-- PARTE 8: VIEWS PARA RELAT√ìRIOS
-- =============================================

-- View para estat√≠sticas mensais
CREATE OR REPLACE VIEW monthly_stats AS
SELECT 
    user_id,
    DATE_TRUNC('month', created_at) as month,
    COUNT(*) as total_leads,
    COUNT(*) FILTER (WHERE status = 'novo') as novos,
    COUNT(*) FILTER (WHERE status = 'agendado') as agendados,
    COUNT(*) FILTER (WHERE status = 'compareceu') as compareceram,
    COUNT(*) FILTER (WHERE status = 'faltou') as faltaram,
    ROUND(
        (COUNT(*) FILTER (WHERE status IN ('agendado', 'compareceu', 'faltou'))::NUMERIC / 
         NULLIF(COUNT(*), 0)) * 100, 1
    ) as taxa_agendamento
FROM leads
GROUP BY user_id, DATE_TRUNC('month', created_at)
ORDER BY month DESC;

-- PARTE 9: VERIFICA√á√ÉO FINAL
-- =============================================

-- Verificar se todas as tabelas foram criadas
SELECT 
    schemaname,
    tablename,
    tableowner,
    hasindexes,
    hasrules,
    hastriggers
FROM pg_tables 
WHERE schemaname = 'public' 
  AND tablename IN ('user_settings', 'leads', 'subscriptions')
ORDER BY tablename;

-- Verificar pol√≠ticas RLS
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    cmd
FROM pg_policies 
WHERE schemaname = 'public'
  AND tablename IN ('user_settings', 'leads', 'subscriptions')
ORDER BY tablename, policyname;

-- Verificar √≠ndices criados
SELECT 
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public'
  AND tablename IN ('user_settings', 'leads', 'subscriptions')
ORDER BY tablename, indexname;

-- =============================================
-- INSTRU√á√ïES DE USO
-- =============================================

/*
COMO USAR ESTE SCRIPT:

1. BACKUP: Se voc√™ j√° tem dados, fa√ßa backup primeiro!

2. EXECU√á√ÉO:
   - V√° para o SQL Editor no Supabase
   - Cole TODO este c√≥digo
   - Clique em "Run" (‚ñ∂Ô∏è)
   - Aguarde a execu√ß√£o completa

3. VERIFICA√á√ÉO:
   - V√° para "Table Editor"
   - Verifique se as tabelas foram criadas:
     ‚úÖ user_settings
     ‚úÖ leads  
     ‚úÖ subscriptions

4. TESTE:
   - Teste o login no seu Flash Leads
   - Tente adicionar um lead
   - Verifique se as estat√≠sticas funcionam

5. PROBLEMAS:
   - Se der erro, execute o script em partes
   - Verifique o console para mensagens de erro
   - Certifique-se que as credenciais do Supabase est√£o corretas no HTML

CARACTER√çSTICAS PRINCIPAIS:
‚úÖ Compat√≠vel com o Flash Leads migrado
‚úÖ Seguran√ßa RLS habilitada
‚úÖ Triggers para updated_at autom√°tico
‚úÖ √çndices para performance
‚úÖ Fun√ß√µes para estat√≠sticas
‚úÖ Controle de limites por plano
‚úÖ Views para relat√≥rios
‚úÖ Estrutura otimizada e limpa

ESTRUTURA DAS TABELAS:
- user_settings: Configura√ß√µes da cl√≠nica/usu√°rio
- leads: Dados dos leads (nome, telefone, status, etc.)
- subscriptions: Controle de planos e assinaturas

PR√ìXIMOS PASSOS:
1. Execute este SQL no Supabase
2. Teste o Flash Leads no navegador
3. Fa√ßa login/registro para testar
4. Adicione alguns leads de teste
5. Verifique se as estat√≠sticas funcionam
*/
