<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Leads SaaS - Gest√£o de Leads Profissional</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }

        .auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .auth-card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .auth-card h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2.5em; }
        .auth-card p { color: #7f8c8d; margin-bottom: 30px; font-size: 1.1em; }

        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        .form-group textarea { resize: vertical; min-height: 80px; }

        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-secondary { background: #f8f9fa; color: #2c3e50; border: 2px solid #e9ecef; }
        .btn-success { background: linear-gradient(135deg, #27ae60, #229954); color: white; font-size: 14px; padding: 8px 16px; }
        .btn-info { background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-size: 14px; padding: 8px 16px; }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; font-size: 14px; padding: 8px 16px; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; font-size: 14px; padding: 8px 16px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .auth-switch { margin-top: 20px; color: #7f8c8d; }
        .auth-switch a { color: #3498db; text-decoration: none; font-weight: 600; }
        .auth-switch a:hover { text-decoration: underline; }

        .container { display: none; max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-weight: bold; }

        .controls { padding: 30px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 0.9em; color: #7f8c8d; margin-top: 5px; }

        .controls-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .search-container { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .search-input { padding: 12px 16px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; width: 250px; transition: border-color 0.3s ease; }
        .search-input:focus { outline: none; border-color: #3498db; }
        .status-filter { display: flex; gap: 10px; align-items: center; }
        .status-filter select { padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }

        .period-filter { margin-bottom: 15px; }
        .period-btn { font-size: 14px; padding: 8px 16px; transition: all 0.3s ease; }
        .period-btn.active { background: linear-gradient(135deg, #27ae60, #229954); color: white; transform: translateY(-1px); box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3); }
        .period-btn:not(.active):hover { background: linear-gradient(135deg, #74b9ff, #0984e3); }

        .table-container { padding: 30px; overflow-x: auto; }
        .leads-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .leads-table th { background: linear-gradient(135deg, #34495e, #2c3e50); color: white; padding: 15px; text-align: left; font-weight: 500; }
        .leads-table td { padding: 15px; border-bottom: 1px solid #e9ecef; }
        .leads-table tr:hover { background: #f8f9fa; }

        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .status-novo { background: #fff3cd; color: #856404; }
        .status-agendado { background: #d4edda; color: #155724; }
        .status-compareceu { background: #d1e7dd; color: #0a3622; }
        .status-faltou { background: #f8d7da; color: #58151c; }

        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e9ecef; padding-bottom: 15px; }
        .modal-header h3 { color: #2c3e50; font-size: 1.5em; }
        .close { font-size: 24px; font-weight: bold; cursor: pointer; color: #999; transition: color 0.3s; }
        .close:hover { color: #333; }

        .no-leads { text-align: center; padding: 40px; color: #7f8c8d; }
        .loading { display: flex; justify-content: center; align-items: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Reports Styles */
        .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .report-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; border-left: 4px solid #3498db; }
        .report-number { font-size: 2em; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .report-label { color: #7f8c8d; font-size: 0.9em; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .chart-bar { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        .chart-label { min-width: 120px; font-size: 14px; color: #2c3e50; }
        .chart-progress { flex: 1; height: 20px; background: #ecf0f1; border-radius: 10px; overflow: hidden; }
        .chart-fill { height: 100%; background: linear-gradient(135deg, #3498db, #2980b9); border-radius: 10px; transition: width 0.3s ease; }
        .chart-value { min-width: 40px; font-weight: bold; color: #2c3e50; font-size: 14px; }
        .insights-container { background: #e8f5e8; padding: 20px; border-radius: 10px; border-left: 4px solid #27ae60; }
        .insights-container h4 { color: #27ae60; margin-bottom: 15px; }
        .insights-list { list-style: none; padding: 0; }
        .insights-list li { padding: 8px 0; border-bottom: 1px solid rgba(39, 174, 96, 0.1); color: #2c3e50; }
        .insights-list li:before { content: "üí° "; margin-right: 8px; }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 20px; flex-direction: column; gap: 15px; text-align: center; }
            .header h1 { font-size: 1.8em; }
            .controls { padding: 20px; }
            .controls-top { flex-direction: column; align-items: stretch; gap: 15px; }
            .search-container { flex-direction: column; gap: 10px; }
            .search-input { width: 100%; }
            .status-filter { flex-direction: column; align-items: stretch; gap: 8px; }
            .stats { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .table-container { padding: 15px; }
            .leads-table { font-size: 14px; min-width: 700px; }
            .leads-table th, .leads-table td { padding: 12px 8px; }
            .actions { flex-direction: column; gap: 4px; min-width: 60px; }
            .modal-content { width: 95%; margin: 10px; padding: 20px; }
            .btn { padding: 14px 20px; font-size: 16px; }
            .reports-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-label { min-width: 80px; }
        }
        @media (max-width: 480px) {
            .stats { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.5em; }
            .reports-grid { grid-template-columns: 1fr; }
            .leads-table { min-width: 600px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h1>‚ö° Flash Leads</h1>
            <p>Sistema Profissional de Gest√£o de Leads</p>
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="seu@email.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button class="btn btn-primary" onclick="handleLogin()" style="width: 100%; margin-bottom: 15px;">Entrar</button>
                <button class="btn btn-secondary" onclick="loginWithGoogle()" style="width: 100%; margin-bottom: 15px;">üîç Entrar com Google</button>
                <div class="auth-switch">N√£o tem conta? <a href="#" onclick="showRegister()">Criar conta</a></div>
            </div>
            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerName">Nome Completo</label>
                    <input type="text" id="registerName" placeholder="Seu nome" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" placeholder="seu@email.com" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Senha</label>
                    <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="form-group">
                    <label for="registerClinic">Nome da Cl√≠nica</label>
                    <input type="text" id="registerClinic" placeholder="Sua cl√≠nica" required>
                </div>
                <button class="btn btn-primary" onclick="handleRegister()" style="width: 100%; margin-bottom: 15px;">Criar Conta</button>
                <div class="auth-switch">J√° tem conta? <a href="#" onclick="showLogin()">Fazer login</a></div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="container">
        <div class="header">
            <div>
                <h1>‚ö° Flash Leads</h1>
                <p>Sistema Inteligente de Gest√£o de Leads Odontol√≥gicos</p>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">Usu√°rio</span>
                <button class="btn btn-secondary" onclick="logout()" style="margin-left: 15px; padding: 8px 16px; width: auto;">Sair</button>
            </div>
        </div>

        <div class="controls">
            <div class="stats">
                <div class="stat-card"><div class="stat-number" id="totalLeads">0</div><div class="stat-label">Total de Leads</div></div>
                <div class="stat-card"><div class="stat-number" id="novosLeads">0</div><div class="stat-label">Leads Novos</div></div>
                <div class="stat-card"><div class="stat-number" id="agendadosLeads">0</div><div class="stat-label">Agendados</div></div>
                <div class="stat-card"><div class="stat-number" id="compareceuLeads">0</div><div class="stat-label">Compareceram</div></div>
                <div class="stat-card"><div class="stat-number" id="faltouLeads">0</div><div class="stat-label">Faltaram</div></div>
                <div class="stat-card"><div class="stat-number" id="leadsMes">0</div><div class="stat-label">Leads Este M√™s</div></div>
                <div class="stat-card"><div class="stat-number" id="taxaAgendamento">0%</div><div class="stat-label">Taxa de Agendamento</div></div>
                <div class="stat-card"><div class="stat-number" id="taxaComparecimento">0%</div><div class="stat-label">Taxa de Comparecimento</div></div>
            </div>

            <div class="controls-top">
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="üîç Buscar por nome ou telefone...">
                    <div class="status-filter">
                        <label>Filtrar por status:</label>
                        <select id="statusFilter">
                            <option value="">Todos os status</option>
                            <option value="novo">Novo</option>
                            <option value="agendado">Agendado</option>
                            <option value="compareceu">Compareceu</option>
                            <option value="faltou">Faltou</option>
                        </select>
                    </div>
                </div>
                <div class="period-filter">
                    <label><strong>Filtrar por per√≠odo:</strong></label>
                    <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-info period-btn active" data-period="all" onclick="filterByPeriod('all')">Todos</button>
                        <button class="btn btn-info period-btn" data-period="today" onclick="filterByPeriod('today')">Hoje</button>
                        <button class="btn btn-info period-btn" data-period="week" onclick="filterByPeriod('week')">Esta Semana</button>
                        <button class="btn btn-info period-btn" data-period="month" onclick="filterByPeriod('month')">Este M√™s</button>
                        <button class="btn btn-info period-btn" data-period="quarter" onclick="filterByPeriod('quarter')">Trimestre</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openAddLeadModal()">‚ûï Adicionar Novo Lead</button>
                    <button class="btn btn-info" onclick="showSettingsModal()">‚öôÔ∏è Configura√ß√µes</button>
                    <button class="btn btn-warning" onclick="showReportsModal()">üìä Relat√≥rios</button>
                    <button class="btn btn-success" onclick="refreshSystem()">üîÑ Atualizar</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="leads-table">
                <thead>
                    <tr>
                        <th>Nome do Paciente</th>
                        <th>Telefone</th>
                        <th>Procedimento</th>
                        <th>Data de Entrada</th>
                        <th>Status</th>
                        <th>Observa√ß√µes</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="leadsTableBody">
                    <tr class="no-leads">
                        <td colspan="7">
                            <div class="loading"><div class="spinner"></div></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modals -->
    <div id="addLeadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Adicionar Novo Lead</h3>
                <span class="close" onclick="closeModal('addLeadModal')">&times;</span>
            </div>
            <form id="leadForm">
                <div class="form-group">
                    <label for="patientName">Nome do Paciente *</label>
                    <input type="text" id="patientName" required>
                </div>
                <div class="form-group">
                    <label for="phone">Telefone *</label>
                    <input type="tel" id="phone" required>
                </div>
                <div class="form-group">
                    <label for="procedure">Procedimento Desejado *</label>
                    <select id="procedure" required>
                        <option value="">Selecione o procedimento</option>
                        <option value="Limpeza/Profilaxia">Limpeza/Profilaxia</option>
                        <option value="Clareamento">Clareamento</option>
                        <option value="Implante">Implante</option>
                        <option value="Ortodontia">Ortodontia</option>
                        <option value="Pr√≥tese">Pr√≥tese</option>
                        <option value="Endodontia">Endodontia</option>
                        <option value="Cirurgia">Cirurgia</option>
                        <option value="Periodontia">Periodontia</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status">Status do Lead</label>
                    <select id="status">
                        <option value="novo">Novo</option>
                        <option value="agendado">Agendado</option>
                        <option value="compareceu">Compareceu</option>
                        <option value="faltou">Faltou</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="observations">Observa√ß√µes</label>
                    <textarea id="observations" placeholder="Observa√ß√µes adicionais sobre o lead..."></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%">üíæ Salvar Lead</button>
                </div>
            </form>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Configura√ß√µes da Cl√≠nica</h3>
                <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            </div>
            <div class="form-group">
                <label><strong>Nome da Cl√≠nica:</strong></label>
                <input type="text" id="clinicName" placeholder="Nome da sua cl√≠nica">
            </div>
            <div class="form-group">
                <label><strong>WhatsApp da Cl√≠nica (opcional):</strong></label>
                <input type="tel" id="clinicWhatsapp" placeholder="(11) 99999-9999">
            </div>
            <div class="form-group">
                <label><strong>Mensagem Padr√£o:</strong></label>
                <textarea id="defaultMessage" style="height: 120px;">Ol√° {nome}! üòä

Tudo bem? Aqui √© da {clinica} ü¶∑

Vi que voc√™ tem interesse em {procedimento}. Que tal agendar uma consulta?

Temos hor√°rios dispon√≠veis esta semana!

Posso te ajudar? üìû</textarea>
            </div>
            <div class="form-group">
                <button onclick="saveSettings()" class="btn btn-primary" style="width: 100%;">üíæ Salvar Configura√ß√µes</button>
            </div>
        </div>
    </div>

    <div id="reportsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üìä Relat√≥rios e An√°lises</h3>
                <span class="close" onclick="closeModal('reportsModal')">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <label><strong>Per√≠odo para An√°lise:</strong></label>
                <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="generateReport('week')">Esta Semana</button>
                    <button class="btn btn-info" onclick="generateReport('month')">Este M√™s</button>
                    <button class="btn btn-info" onclick="generateReport('quarter')">Trimestre</button>
                    <button class="btn btn-info" onclick="generateReport('year')">Este Ano</button>
                    <button class="btn btn-info" onclick="generateReport('all')">Todos</button>
                </div>
            </div>
            <div id="reportResults">
                <p style="text-align: center; color: #666; padding: 40px;">Selecione um per√≠odo acima para gerar o relat√≥rio</p>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bjqfxroulfxyqhqopnns.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqcWZ4cm91bGZ4eXFocW9wbm5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNTkzODEsImV4cCI6MjA2ODgzNTM4MX0.7TRJhwzvbHK23rQP2T6azq6c2mVSDPBgfgwadpZxbjg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let currentEditId = null;
        let currentPeriodFilter = 'all';
        let leads = [];
        let userSettings = {
            clinic_name: 'Minha Cl√≠nica',
            whatsapp: '',
            default_message: 'Ol√° {nome}! üòä\n\nTudo bem? Aqui √© da {clinica} ü¶∑\n\nVi que voc√™ tem interesse em {procedimento}. Que tal agendar uma consulta?\n\nTemos hor√°rios dispon√≠veis esta semana!\n\nPosso te ajudar? üìû',
            auto_reminders: false,
            reminder_days: 2
        };

        document.addEventListener('DOMContentLoaded', async function() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) { currentUser = session.user; showMainApp(); } 
            else { showAuthScreen(); }
            
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') { currentUser = session.user; showMainApp(); } 
                else if (event === 'SIGNED_OUT') { currentUser = null; showAuthScreen(); }
            });
        });

        function showLogin() { document.getElementById('loginForm').style.display = 'block'; document.getElementById('registerForm').style.display = 'none'; }
        function showRegister() { document.getElementById('loginForm').style.display = 'none'; document.getElementById('registerForm').style.display = 'block'; }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { showAlert('Preencha todos os campos!', 'error'); return; }
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                showAlert('Login realizado!', 'success');
            } catch (error) { showAlert('Erro: ' + error.message, 'error'); }
        }

        async function handleRegister() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const clinic = document.getElementById('registerClinic').value;
            try {
                const { data, error } = await supabase.auth.signUp({
                    email, password,
                    options: { data: { full_name: name, clinic_name: clinic } }
                });
                if (error) throw error;
                showAlert('Conta criada! Verifique seu email.', 'success');
                showLogin();
            } catch (error) { showAlert('Erro: ' + error.message, 'error'); }
        }

        async function loginWithGoogle() {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: window.location.origin }
                });
                if (error) throw error;
            } catch (error) { showAlert('Erro Google: ' + error.message, 'error'); }
        }

        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                showAlert('Logout realizado!', 'success');
            } catch (error) { showAlert('Erro logout: ' + error.message, 'error'); }
        }

        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        async function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            setupUserInfo();
            setupEventListeners();
            await loadUserData();
            await loadLeads();
            updateStats();
            renderLeads();
        }

        function setupUserInfo() {
            const userName = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
            document.getElementById('userName').textContent = userName;
            document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterLeads);
            document.getElementById('statusFilter').addEventListener('change', filterLeads);
            document.getElementById('leadForm').addEventListener('submit', handleFormSubmit);
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) event.target.style.display = 'none';
            });
        }

        async function loadUserData() {
            try {
                const { data: settings, error } = await supabase
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                if (settings) userSettings = settings;
                else await createDefaultSettings();
            } catch (error) { console.error('Erro carregar dados:', error); }
        }

        async function createDefaultSettings() {
            const defaultSettings = {
                user_id: currentUser.id,
                clinic_name: currentUser.user_metadata?.clinic_name || 'Minha Cl√≠nica',
                whatsapp: '',
                default_message: userSettings.default_message,
                auto_reminders: false,
                reminder_days: 2
            };
            try {
                const { data, error } = await supabase.from('user_settings').insert([defaultSettings]).select().single();
                if (error) throw error;
                userSettings = data;
            } catch (error) { console.error('Erro criar config:', error); }
        }

        async function loadLeads() {
            try {
                const { data, error } = await supabase
                    .from('leads')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                if (error) throw error;
                leads = data || [];
            } catch (error) { console.error('Erro carregar leads:', error); leads = []; }
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const formData = {
                name: document.getElementById('patientName').value,
                phone: document.getElementById('phone').value,
                procedure: document.getElementById('procedure').value,
                status: document.getElementById('status').value,
                observations: document.getElementById('observations').value
            };
            if (currentEditId) updateLead(currentEditId, formData);
            else addLead(formData);
        }

        async function addLead(formData) {
            if (!formData.name || !formData.phone || !formData.procedure) {
                showAlert('Preencha os campos obrigat√≥rios!', 'error');
                return;
            }
            const newLead = {
                user_id: currentUser.id,
                name: formData.name,
                phone: formData.phone,
                procedure: formData.procedure,
                status: formData.status || 'novo',
                observations: formData.observations || '',
                created_at: new Date().toISOString()
            };
            try {
                const { data, error } = await supabase.from('leads').insert([newLead]).select().single();
                if (error) throw error;
                leads.unshift(data);
                updateStats();
                renderLeads();
                closeModal('addLeadModal');
                document.getElementById('leadForm').reset();
                showAlert('Lead adicionado!', 'success');
            } catch (error) { showAlert('Erro: ' + error.message, 'error'); }
        }

        async function updateLead(leadId, formData) {
            try {
                const { data, error } = await supabase
                    .from('leads')
                    .update({ ...formData, updated_at: new Date().toISOString() })
                    .eq('id', leadId)
                    .eq('user_id', currentUser.id)
                    .select()
                    .single();
                if (error) throw error;
                const index = leads.findIndex(lead => lead.id === leadId);
                if (index !== -1) leads[index] = data;
                updateStats();
                renderLeads();
                closeModal('addLeadModal');
                document.getElementById('leadForm').reset();
                currentEditId = null;
                document.getElementById('modalTitle').textContent = 'Adicionar Novo Lead';
                showAlert('Lead atualizado!', 'success');
            } catch (error) { showAlert('Erro: ' + error.message, 'error'); }
        }

        async function updateLeadStatus(leadId, newStatus) {
            try {
                const { data, error } = await supabase
                    .from('leads')
                    .update({ status: newStatus, updated_at: new Date().toISOString() })
                    .eq('id', leadId)
                    .eq('user_id', currentUser.id)
                    .select()
                    .single();
                if (error) throw error;
                const index = leads.findIndex(lead => lead.id === leadId);
                if (index !== -1) leads[index] = data;
                updateStats();
                renderLeads();
                showAlert('Status atualizado!', 'success');
            } catch (error) { showAlert('Erro: ' + error.message, 'error'); }
        }

        async function deleteLead(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead || !confirm(`Excluir lead de ${lead.name}?`)) return;
            try {
                const { error } = await supabase.from('leads').delete().eq('id', leadId).eq('user_id', currentUser.id);
                if (error) throw error;
                leads = leads.filter(lead => lead.id !== leadId);
                updateStats();
                renderLeads();
                showAlert('Lead exclu√≠do!', 'success');
            } catch (error) { showAlert('Erro: ' + error.message, 'error'); }
        }

        function updateStats() {
            const total = leads.length;
            const novos = leads.filter(lead => lead.status === 'novo').length;
            const agendados = leads.filter(lead => lead.status === 'agendado').length;
            const compareceu = leads.filter(lead => lead.status === 'compareceu').length;
            const faltou = leads.filter(lead => lead.status === 'faltou').length;
            
            const leadsProcessados = leads.filter(lead => ['agendado', 'compareceu', 'faltou'].includes(lead.status)).length;
            const taxaAgendamento = total > 0 ? Math.round((leadsProcessados / total) * 100) : 0;
            const totalConsultas = compareceu + faltou;
            const taxaComparecimento = totalConsultas > 0 ? Math.round((compareceu / totalConsultas) * 100) : 0;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const leadsMes = leads.filter(lead => {
                const leadDate = new Date(lead.created_at);
                return leadDate.getMonth() === currentMonth && leadDate.getFullYear() === currentYear;
            }).length;

            document.getElementById('totalLeads').textContent = total;
            document.getElementById('novosLeads').textContent = novos;
            document.getElementById('agendadosLeads').textContent = agendados;
            document.getElementById('compareceuLeads').textContent = compareceu;
            document.getElementById('faltouLeads').textContent = faltou;
            document.getElementById('taxaAgendamento').textContent = taxaAgendamento + '%';
            document.getElementById('taxaComparecimento').textContent = taxaComparecimento + '%';
            document.getElementById('leadsMes').textContent = leadsMes;
        }

        function renderLeads(filteredLeads = null) {
            const tbody = document.getElementById('leadsTableBody');
            const leadsToRender = filteredLeads || leads;
            
            if (leadsToRender.length === 0) {
                let message = 'Clique em "Adicionar Novo Lead" para come√ßar';
                if (filteredLeads !== null && leads.length > 0) message = 'Nenhum lead encontrado com os filtros aplicados';
                tbody.innerHTML = `<tr class="no-leads"><td colspan="7"><h3>Nenhum lead encontrado</h3><p>${message}</p></td></tr>`;
                return;
            }

            tbody.innerHTML = leadsToRender.map(lead => `
                <tr>
                    <td><strong>${lead.name}</strong></td>
                    <td>${lead.phone}</td>
                    <td>${lead.procedure}</td>
                    <td>${formatDate(lead.created_at)}</td>
                    <td><span class="status-badge status-${lead.status}">${getStatusText(lead.status)}</span></td>
                    <td>${lead.observations || '-'}</td>
                    <td>
                        <div class="actions">
                            ${lead.status === 'novo' ? `<button class="btn btn-success" onclick="updateLeadStatus(${lead.id}, 'agendado')" title="Agendar">üìÖ</button>` : ''}
                            <button class="btn btn-info" onclick="sendWhatsApp('${lead.phone}', '${lead.name}', '${lead.procedure}')" title="WhatsApp">üí¨</button>
                            ${lead.status === 'agendado' ? `
                                <button class="btn btn-success" onclick="updateLeadStatus(${lead.id}, 'compareceu')" title="Compareceu">‚úÖ</button>
                                <button class="btn btn-danger" onclick="updateLeadStatus(${lead.id}, 'faltou')" title="Faltou">‚ùå</button>
                            ` : ''}
                            <button class="btn btn-warning" onclick="editLead(${lead.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deleteLead(${lead.id})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterLeads() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            let filtered = leads.filter(lead => {
                const matchesSearch = lead.name.toLowerCase().includes(searchTerm) || lead.phone.includes(searchTerm);
                const matchesStatus = !statusFilter || lead.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            filtered = applyPeriodFilter(filtered);
            renderLeads(filtered);
            updateFilteredStats(filtered);
        }

        function applyPeriodFilter(leadsArray) {
            if (currentPeriodFilter === 'all') return leadsArray;
            const now = new Date();
            let startDate;
            switch(currentPeriodFilter) {
                case 'today': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
                case 'week': startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                case 'quarter': startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1); break;
                default: return leadsArray;
            }
            return leadsArray.filter(lead => new Date(lead.created_at) >= startDate);
        }

        function filterByPeriod(period) {
            currentPeriodFilter = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            filterLeads();
        }

        function updateFilteredStats(filteredLeads) {
            const total = filteredLeads.length;
            const novos = filteredLeads.filter(lead => lead.status === 'novo').length;
            const agendados = filteredLeads.filter(lead => lead.status === 'agendado').length;
            const compareceu = filteredLeads.filter(lead => lead.status === 'compareceu').length;
            const faltou = filteredLeads.filter(lead => lead.status === 'faltou').length;
            
            const leadsProcessados = filteredLeads.filter(lead => ['agendado', 'compareceu', 'faltou'].includes(lead.status)).length;
            const taxaAgendamento = total > 0 ? Math.round((leadsProcessados / total) * 100) : 0;
            const totalConsultas = compareceu + faltou;
            const taxaComparecimento = totalConsultas > 0 ? Math.round((compareceu / totalConsultas) * 100) : 0;
            
            let leadsPeriodo;
            if (currentPeriodFilter === 'all') {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                leadsPeriodo = leads.filter(lead => {
                    const leadDate = new Date(lead.created_at);
                    return leadDate.getMonth() === currentMonth && leadDate.getFullYear() === currentYear;
                }).length;
            } else { leadsPeriodo = total; }

            document.getElementById('totalLeads').textContent = total;
            document.getElementById('novosLeads').textContent = novos;
            document.getElementById('agendadosLeads').textContent = agendados;
            document.getElementById('compareceuLeads').textContent = compareceu;
            document.getElementById('faltouLeads').textContent = faltou;
            document.getElementById('taxaAgendamento').textContent = taxaAgendamento + '%';
            document.getElementById('taxaComparecimento').textContent = taxaComparecimento + '%';
            document.getElementById('leadsMes').textContent = leadsPeriodo;
        }

        function sendWhatsApp(phone, name, procedure) {
            const message = userSettings.default_message
                .replace('{nome}', name)
                .replace('{clinica}', userSettings.clinic_name)
                .replace('{procedimento}', procedure);
            const cleanPhone = phone.replace(/\D/g, '');
            const formattedPhone = cleanPhone.startsWith('55') ? cleanPhone : '55' + cleanPhone;
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            window.open(whatsappURL, '_blank');
            showAlert(`WhatsApp aberto para ${name}!`, 'success');
        }

        function editLead(id) {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;
            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'Editar Lead';
            document.getElementById('patientName').value = lead.name;
            document.getElementById('phone').value = lead.phone;
            document.getElementById('procedure').value = lead.procedure;
            document.getElementById('status').value = lead.status;
            document.getElementById('observations').value = lead.observations || '';
            document.getElementById('addLeadModal').style.display = 'block';
        }

        function showReportsModal() { document.getElementById('reportsModal').style.display = 'block'; }

        function generateReport(period) {
            const reportContainer = document.getElementById('reportResults');
            reportContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            setTimeout(() => {
                const filteredLeads = filterLeadsByPeriod(leads, period);
                displayReport(filteredLeads, period);
            }, 800);
        }

        function filterLeadsByPeriod(leadsArray, period) {
            if (period === 'all') return leadsArray;
            const now = new Date();
            let startDate;
            switch(period) {
                case 'week': startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                case 'quarter': startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1); break;
                case 'year': startDate = new Date(now.getFullYear(), 0, 1); break;
                default: return leadsArray;
            }
            return leadsArray.filter(lead => new Date(lead.created_at) >= startDate);
        }

        function displayReport(filteredLeads, period) {
            const total = filteredLeads.length;
            const novo = filteredLeads.filter(l => l.status === 'novo').length;
            const agendado = filteredLeads.filter(l => l.status === 'agendado').length;
            const compareceu = filteredLeads.filter(l => l.status === 'compareceu').length;
            const faltou = filteredLeads.filter(l => l.status === 'faltou').length;
            
            const taxaAgendamento = total > 0 ? ((agendado / total) * 100).toFixed(1) : 0;
            const taxaComparecimento = (agendado + compareceu + faltou) > 0 ? 
                ((compareceu / (agendado + compareceu + faltou)) * 100).toFixed(1) : 0;
            const taxaConversao = total > 0 ? (((agendado + compareceu) / total) * 100).toFixed(1) : 0;
            
            const procedimentos = {};
            filteredLeads.forEach(lead => {
                if (!procedimentos[lead.procedure]) procedimentos[lead.procedure] = { total: 0, agendados: 0 };
                procedimentos[lead.procedure].total++;
                if (['agendado', 'compareceu'].includes(lead.status)) procedimentos[lead.procedure].agendados++;
            });
            
            const procedimentosOrdenados = Object.entries(procedimentos).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
            const insights = generateInsights(filteredLeads, taxaAgendamento, taxaComparecimento, procedimentosOrdenados);
            
            const reportHTML = `
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä Relat√≥rio: ${getPeriodName(period)}</h3>
                    <div class="reports-grid">
                        <div class="report-card"><div class="report-number">${total}</div><div class="report-label">Total de Leads</div></div>
                        <div class="report-card"><div class="report-number">${taxaAgendamento}%</div><div class="report-label">Taxa de Agendamento</div></div>
                        <div class="report-card"><div class="report-number">${taxaComparecimento}%</div><div class="report-label">Taxa de Comparecimento</div></div>
                        <div class="report-card"><div class="report-number">${taxaConversao}%</div><div class="report-label">Taxa de Convers√£o</div></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;"><strong>${novo}</strong><br>Novos</div>
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;"><strong>${agendado}</strong><br>Agendados</div>
                        <div style="background: #d1e7dd; padding: 15px; border-radius: 8px; text-align: center;"><strong>${compareceu}</strong><br>Compareceram</div>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;"><strong>${faltou}</strong><br>Faltaram</div>
                    </div>
                    ${procedimentosOrdenados.length > 0 ? `
                        <div class="chart-container">
                            <h4 style="margin-bottom: 15px; color: #2c3e50;">üìã Procedimentos Mais Procurados</h4>
                            ${procedimentosOrdenados.map(([proc, data]) => {
                                const percentage = total > 0 ? (data.total / total) * 100 : 0;
                                return `<div class="chart-bar"><div class="chart-label">${proc}</div><div class="chart-progress"><div class="chart-fill" style="width: ${percentage}%"></div></div><div class="chart-value">${data.total}</div></div>`;
                            }).join('')}
                        </div>
                    ` : ''}
                    <div class="insights-container">
                        <h4>üí° Insights e Recomenda√ß√µes</h4>
                        <ul class="insights-list">${insights.map(insight => `<li>${insight}</li>`).join('')}</ul>
                    </div>
                </div>
            `;
            document.getElementById('reportResults').innerHTML = reportHTML;
        }

        function generateInsights(leads, taxaAgendamento, taxaComparecimento, procedimentosOrdenados) {
            const insights = [];
            if (parseFloat(taxaAgendamento) < 30) insights.push('Taxa de agendamento baixa. Considere melhorar o follow-up dos leads.');
            else if (parseFloat(taxaAgendamento) > 70) insights.push('Excelente taxa de agendamento! Continue com a estrat√©gia atual.');
            if (parseFloat(taxaComparecimento) < 60) insights.push('Taxa de comparecimento pode melhorar. Considere enviar lembretes via WhatsApp.');
            else if (parseFloat(taxaComparecimento) > 85) insights.push('√ìtima taxa de comparecimento! Seus pacientes s√£o bem engajados.');
            if (procedimentosOrdenados.length > 0) {
                const topProcedimento = procedimentosOrdenados[0];
                insights.push(`Procedimento mais procurado: ${topProcedimento[0]} (${topProcedimento[1].total} leads).`);
            }
            if (insights.length === 0) insights.push('Continue monitorando os indicadores para identificar oportunidades de melhoria.');
            return insights;
        }

        function getPeriodName(period) {
            const periodMap = { 'week': 'Esta Semana', 'month': 'Este M√™s', 'quarter': 'Este Trimestre', 'year': 'Este Ano', 'all': 'Todos os Per√≠odos' };
            return periodMap[period] || period;
        }

        function showSettingsModal() {
            document.getElementById('clinicName').value = userSettings.clinic_name || '';
            document.getElementById('clinicWhatsapp').value = userSettings.whatsapp || '';
            document.getElementById('defaultMessage').value = userSettings.default_message || '';
            document.getElementById('settingsModal').style.display = 'block';
        }

        async function saveSettings() {
            const clinicName = document.getElementById('clinicName').value;
            const clinicWhatsapp = document.getElementById('clinicWhatsapp').value;
            const defaultMessage = document.getElementById('defaultMessage').value;
            const updatedSettings = { clinic_name: clinicName, whatsapp: clinicWhatsapp, default_message: defaultMessage, updated_at: new Date().toISOString() };
            try {
                const { data, error } = await supabase.from('user_settings').update(updatedSettings).eq('user_id', currentUser.id).select().single();
                if (error) throw error;
                userSettings = { ...userSettings, ...data };
                closeModal('settingsModal');
                showAlert('Configura√ß√µes salvas!', 'success');
            } catch (error) { showAlert('Erro: ' + error.message, 'error'); }
        }

        function openAddLeadModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Adicionar Novo Lead';
            document.getElementById('leadForm').reset();
            document.getElementById('addLeadModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'addLeadModal') {
                currentEditId = null;
                document.getElementById('modalTitle').textContent = 'Adicionar Novo Lead';
            }
        }

        function refreshSystem() {
            const refreshBtn = document.querySelector('.btn-success');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '‚è≥ Atualizando...';
            refreshBtn.disabled = true;
            setTimeout(async () => {
                try {
                    await loadLeads();
                    await loadUserData();
                    document.getElementById('searchInput').value = '';
                    document.getElementById('statusFilter').value = '';
                    filterByPeriod('all');
                    updateStats();
                    renderLeads();
                    showAlert('Sistema atualizado!', 'success');
                } catch (error) { showAlert('Erro ao atualizar!', 'error'); }
                finally { refreshBtn.innerHTML = originalText; refreshBtn.disabled = false; }
            }, 800);
        }

        function showAlert(message, type) {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            const container = document.querySelector('.auth-card') || document.querySelector('.container');
            if (container) container.insertBefore(alert, container.firstChild);
            setTimeout(() => { if (alert.parentNode) alert.remove(); }, 5000);
        }

        function formatDate(dateString) { return new Date(dateString).toLocaleDateString('pt-BR'); }
        function getStatusText(status) {
            const statusMap = { 'novo': 'Novo', 'agendado': 'Agendado', 'compareceu': 'Compareceu', 'faltou': 'Faltou' };
            return statusMap[status] || status;
        }

        // Global functions
        window.filterByPeriod = filterByPeriod;
        window.updateLeadStatus = updateLeadStatus;
        window.sendWhatsApp = sendWhatsApp;
        window.editLead = editLead;
        window.deleteLead = deleteLead;
        window.openAddLeadModal = openAddLeadModal;
        window.closeModal = closeModal;
        window.showSettingsModal = showSettingsModal;
        window.saveSettings = saveSettings;
        window.showReportsModal = showReportsModal;
        window.generateReport = generateReport;
        window.refreshSystem = refreshSystem;
        window.showLogin = showLogin;
        window.showRegister = showRegister;
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.loginWithGoogle = loginWithGoogle;
        window.logout = logout;
    </script>
</body>
</html>
